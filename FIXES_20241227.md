# Correcciones - 27 de Diciembre 2024

## Problema 1: Cambio de Rol en Panel Admin No Funciona

### Causa:
Las políticas RLS (Row Level Security) de Supabase solo permitían que los usuarios actualizaran su propio perfil, pero no permitían que los administradores actualizaran perfiles de otros usuarios.

### Solución:
1. **Creada nueva migración SQL:** `db/migrations/20251227_fix_admin_permissions.sql`
2. **Agregada política RLS para admins:**
   ```sql
   CREATE POLICY "Admins can update all profiles"
   ON profiles FOR UPDATE
   USING (
     EXISTS (
       SELECT 1 FROM profiles
       WHERE id = auth.uid() 
       AND role = 'admin'
     )
   );
   ```

### Instrucciones:
**Ejecuta este SQL en Supabase SQL Editor:**
```sql
-- Permitir que administradores actualicen cualquier perfil
DROP POLICY IF EXISTS "Admins can update all profiles" ON profiles;

CREATE POLICY "Admins can update all profiles"
ON profiles FOR UPDATE
USING (
  EXISTS (
    SELECT 1 FROM profiles
    WHERE id = auth.uid() 
    AND role = 'admin'
  )
);
```

Después de ejecutar este SQL, el botón de cambiar rol funcionará correctamente.

---

## Problema 2: Sesiones No Se Invalidan Correctamente

### Causa:
Cuando se cerraban las sesiones antiguas desde un dispositivo nuevo, los dispositivos antiguos seguían funcionando porque:
1. El token de autenticación de Supabase seguía siendo válido
2. No había verificación periódica de si la sesión fue eliminada de la base de datos

### Solución:

#### 1. Agregado método de verificación de sesión en `session_manager.dart`:
```dart
static Future<bool> isSessionValid() async {
  // Verifica si la sesión actual existe en la tabla user_sessions
  final response = await _supabase
      .from('user_sessions')
      .select('id')
      .eq('user_id', userId)
      .eq('session_token', sessionToken)
      .maybeSingle();
  
  return response != null;
}
```

#### 2. Implementada verificación periódica en `payments_list.dart`:
- **Timer periódico:** Verifica cada 30 segundos si la sesión sigue existiendo
- **Cierre automático:** Si la sesión fue eliminada, cierra sesión localmente y redirige al login
- **Notificación al usuario:** Muestra mensaje explicando que la sesión fue cerrada desde otro dispositivo

### Flujo de funcionamiento:
1. Usuario A inicia sesión en dispositivo 1
2. Usuario A intenta iniciar sesión en dispositivo 2 (alcanza límite)
3. Usuario A confirma cerrar sesiones anteriores
4. Sistema elimina sesión del dispositivo 1 de la tabla `user_sessions`
5. **Dispositivo 1:** El timer detecta (en máximo 30 segundos) que su sesión fue eliminada
6. **Dispositivo 1:** Cierra sesión automáticamente y muestra mensaje
7. Usuario A puede continuar en dispositivo 2

---

## Archivos Modificados

### 1. `lib/utils/session_manager.dart`
- ✅ Agregado método `isSessionValid()` para verificar si sesión existe

### 2. `lib/screens/payments_list.dart`
- ✅ Agregada variable `Timer? _sessionCheckTimer`
- ✅ Agregado método `_startSessionValidation()` - inicia verificación periódica
- ✅ Agregado método `_handleSessionInvalidated()` - maneja cierre de sesión
- ✅ Modificado `initState()` - inicia timer de verificación
- ✅ Modificado `dispose()` - cancela timer al salir

### 3. `db/migrations/20251227_fix_admin_permissions.sql`
- ✅ Creada nueva política RLS para permitir actualizaciones de admin

---

## Pruebas Recomendadas

### Probar Cambio de Rol:
1. Ejecuta la migración SQL en Supabase
2. Inicia sesión como administrador
3. Ve al panel de administración
4. Selecciona un usuario
5. Presiona "Cambiar rol"
6. Selecciona un nuevo rol y guarda
7. **Resultado esperado:** El rol debe cambiar y mostrarse actualizado

### Probar Invalidación de Sesiones:
1. Inicia sesión en Chrome (dispositivo 1) con rol que tiene límite de 1 sesión
2. **Deja Chrome abierto y trabajando**
3. Inicia sesión en Edge (dispositivo 2)
4. Confirma cerrar sesiones anteriores
5. **Observa Chrome:** En máximo 30 segundos debe cerrar sesión automáticamente
6. Debe mostrar mensaje: "Tu sesión ha sido cerrada desde otro dispositivo"
7. Chrome debe redirigir al login

### Probar con Usuario Free (2 sesiones):
1. Inicia sesión en Chrome (dispositivo 1)
2. Inicia sesión en Edge (dispositivo 2)
3. Ambos deben funcionar correctamente
4. Intenta iniciar sesión en Firefox (dispositivo 3)
5. Confirma cerrar sesiones anteriores
6. Chrome y Edge deben cerrar sesión en máximo 30 segundos cada uno
7. Firefox debe funcionar normalmente

---

## Configuración del Timer

El timer está configurado para verificar cada **30 segundos**. Puedes ajustar este valor si lo deseas:

```dart
// En payments_list.dart línea ~220
_sessionCheckTimer = Timer.periodic(
  const Duration(seconds: 30), // Cambia este valor
  (timer) async {
    // ...
  }
);
```

**Recomendaciones:**
- **30 segundos:** Balance entre respuesta rápida y uso de recursos
- **60 segundos:** Menor consumo de red, respuesta más lenta
- **15 segundos:** Respuesta muy rápida, más consultas a la BD

---

## Notas Importantes

1. **RLS debe estar habilitado:** Asegúrate de que Row Level Security esté activo en las tablas `profiles` y `user_sessions`

2. **Timer solo en pantalla principal:** El timer solo funciona mientras el usuario está en `payments_list`. Si quieres que funcione en todas las pantallas, necesitarías implementarlo en cada una.

3. **Manejo de errores:** Si hay un error al verificar la sesión, el sistema asume que es válida para evitar cierres inesperados.

4. **Sincronización no instantánea:** Hay un delay de hasta 30 segundos antes de que el dispositivo antiguo detecte que su sesión fue cerrada. Esto es normal y esperado.

---

## Próximos Pasos Opcionales

1. **Implementar en todas las pantallas:** Agregar el timer de verificación en Profile, Admin, Statistics
2. **Push notifications:** Usar notificaciones para avisar inmediatamente cuando se cierra sesión
3. **Websockets:** Implementar conexión en tiempo real para detección instantánea
4. **Log de sesiones:** Guardar historial de inicios/cierres de sesión para auditoría
